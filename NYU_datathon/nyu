-- This cohort is derived from multiple other materialized views and tables from the MIMIC-III 
-- git hub repository  (https://github.com/MIT-LCP/mimic-code/tree/master/concepts),
-- which were either used directly or modified.

-- Reference for SOFA:
--    Jean-Louis Vincent, Rui Moreno, Jukka Takala, Sheila Willatts, Arnaldo De Mendon√ßa,
--    Hajo Bruining, C. K. Reinhart, Peter M Suter, and L. G. Thijs.
--    "The SOFA (Sepsis-related Organ Failure Assessment) score to describe organ dysfunction/failure."
--    Intensive care medicine 22, no. 7 (1996): 707-710.

-- Variables used in SOFA:
--  GCS, MAP, FiO2, Ventilation status (sourced from CHARTEVENTS)
--  Creatinine, Bilirubin, FiO2, PaO2, Platelets (sourced from LABEVENTS)
--  Dopamine, Dobutamine, Epinephrine, Norepinephrine (sourced from INPUTEVENTS_MV and INPUTEVENTS_CV)
--  Urine output (sourced from OUTPUTEVENTS)

-- The following views required to run the SOFA query:
--  1) pivoted_bg_art - generated by pivoted-bg.sql
--  2) pivoted_uo - generated by pivoted-uo.sql
--  3) pivoted_lab - generated by pivoted-lab.sql
--  4) pivoted_gcs - generated by pivoted-gcs.sql
--  5) ventdurations - generated by ../durations/ventilation-durations.sql
--  6) norepinephrine_dose - generated by ../durations/norepinephrine-dose.sql
--  7) epinephrine_dose - generated by ../durations/epinephrine-dose.sql
--  8) dopamine_dose - generated by ../durations/dopamine-dose.sql
--  9) dobutamine_dose - generated by ../durations/dobutamine-dose.sql

-- The following was also used for the final table:
-- 1) icustay_detail - generated by icustay-detail.sql

-- In addition to the tables used for SOFA, the modified tables used in this query are found at: 
-- https://github.com/atobrien/Predicting-optimal-invasive-care-treatment-window-in-the-ICU/tree/master/SQL/MIMIC
-- 1) CMO_sequence
-- 2) central_line_sequence
-- 3) crrt_sequence
-- 4) day_sequence
-- 5) mech_vent_seqeuence
-- 6) vasopressor_sequence


WITH v1 AS(
        SELECT
		*,
	    date_trunc('day', startday) AS day_start,
	    date_trunc('day', endday) AS day_end
	    FROM transition), 

     v2 AS(
	    SELECT
	    *,
	    cv_day AS day_start
	    FROM central), 

  	 v3 AS(
	    SELECT
	    *,
	    crrt_day AS day_start	
	    FROM crrt),
	 
	 v4 AS(
	    SELECT
	    *,
	    vasopres_day AS day_start
	    FROM vaso),

     m1 AS(
        SELECT
        *,
        date_trunc('day', charttime) AS day_start
        FROM mech_vent
        WHERE mechvent = 1 
        ORDER BY icustay_id, charttime),
 
     v5 AS(
 	    SELECT DISTINCT
        icustay_id,
        day_start,
		day_start AS mech_day,
        mechvent
        FROM m1),

      sofa AS(
	      SELECT 
          *,
          date_trunc('day', starttime) AS day_start
	      FROM pivoted_sofa
          ORDER BY icustay_id, starttime),

       v6 AS(
		  SELECT DISTINCT
          icustay_id,
          day_start,
          day_start AS sofa_day,
		  LAST_VALUE(sofa_24hours) OVER (PARTITION BY icustay_id, day_start ORDER BY day_start) AS sofa_last
		  FROM SOFA),

       v7 AS(
		  SELECT
          icustay_id,
          timecmo_chart,
          date_trunc('day', timecmo_chart) AS day_start,
          CASE WHEN timecmo_chart IS NOT NULL THEN 1 ELSE 0 END AS cmo_flag
          FROM status
          WHERE timecmo_chart IS NOT NULL
          ORDER BY icustay_id, day_start),

     dem AS(
	     SELECT
         icustay_id,
         gender,
         admission_age,
         first_icu_stay
         FROM icustay_detail 
	         ),

outcome AS(	
        SELECT
        icustay_id,
	    dod AS day_start,
        CASE WHEN dod IS NOT NULL THEN 1 ELSE 0 END AS death_flag
        FROM icustay_detail
	       ),

cir1 AS(
          SELECT DISTINCT 
          icustay_id,
          charttime,
          date_trunc('day', charttime) AS day_start,
          ROW_NUMBER() OVER (PARTITION BY mimiciii.noteevents.subject_id ORDER BY  mimiciii.noteevents.charttime DESC) AS position
          FROM mimiciii.noteevents
          LEFT JOIN mimiciii.icustays icu
          USING (subject_id, hadm_id)
          WHERE text similar to '%cirrhosis%'),
 
cir2 AS (
	 SELECT
     icustay_id, 
     charttime,
     day_start,
     CASE WHEN day_start = day_start THEN 1 END AS cirrhosis_flag 
     FROM cir1
     WHERE position = 1 --we only want the hadm_id associated with the very last note
     AND charttime IS NOT NULL
     AND icustay_id IS NOT NULL
     ORDER BY icustay_id),

       v8 AS(
		  SELECT
		  *
		  FROM v1 --this is the day sequence table for patients in the icu
		  LEFT JOIN v2 --this is the central venous line table flag table
          USING (icustay_id,day_start)
          LEFT JOIN v3 --this is the continuous renal replacement therapy flag table
          USING (icustay_id,day_start)
          LEFT JOIN v4 --this is the vasopressor flag table
          USING (icustay_id,day_start)
          LEFT JOIN v5 --this is the mechanical ventilation flag table
          USING (icustay_id,day_start)
          LEFT JOIN v6 --this is the sofa 24 hour flag table
          USING (icustay_id,day_start)
          LEFT JOIN v7 --this is the cmo flag table
          USING (icustay_id,day_start)	
		  LEFT JOIN dem --this is the icustay_detail table for demographic
		  USING (icustay_id)
		  LEFT JOIN outcome -- this is the icustay_detail table for death flag
		  USING (icustay_id,day_start)
		  LEFT JOIN cir2 -- this is the table for selecting patients with cirrhosis 
		  USING (icustay_id,day_start)
		   ),
	
	 v9 AS(
        SELECT
        icustay_id,
        startday,
        endday,
        icudayseq_asc,
        cv_flag,
        crrt_flag,
        vasopres_flag,
        mechvent AS mechvent_flag,
        cmo_flag,
        sofa_last,
		death_flag,
		gender,
        admission_age,
        first_icu_stay,
		day_start,
        CASE WHEN (cv_flag = 1 OR crrt_flag = 1 OR vasopres_flag = 1 OR mechvent = 1) THEN 1 ELSE 0 END AS status_flag,
		cirrhosis_flag
        FROM v8),

     v10 AS(
	     SELECT
         icustay_id,
         startday,
         endday,
         icudayseq_asc,
         sofa_last,
         death_flag,
         gender,
         admission_age,
         first_icu_stay,
         CASE WHEN cmo_flag = 1 THEN 2 ELSE status_flag END AS state_transition, --icu is 0, invasive care is 1 and cmo is 2
		 LEAD(icudayseq_asc) OVER (PARTITION BY icustay_id ORDER BY icudayseq_asc) AS icustay_asc_lead
         FROM v9	 
	        ),
			
	 v11 AS (
	     SELECT
         *,
         icustay_asc_lead-icudayseq_asc AS ending_stay_flag --when null it means the person is no longer registered in the icu (so they left)
         FROM V10
	         ),	
	
	v12 AS (
		SELECT
		icustay_id,
		startday,
		endday,
		icudayseq_asc,
		sofa_last,
		death_flag,
		gender,
		admission_age,
		first_icu_stay,
		CASE WHEN (ending_stay_flag IS NULL AND death_flag IS NULL) THEN 3 --the patient left the icu
		WHEN death_flag = 1 THEN 4 -- the patient died
		ELSE state_transition END AS states --this combines state transition to include home and death
		FROM V11),

	v13 AS(
		SELECT *
		FROM v12
		LEFT JOIN icustay_detail
		USING (icustay_id)
		ORDER BY icustay_id, icudayseq_asc)
		
 v14 AS( SELECT 
		hadm_id,
		count(aniongap) as ag_count,
		count(albumin)as alb_count,
		count(bands) as bands_count,
		count(bicarbonate) as bicarb_count,
		count(bilirubin) as bilir_count,
		count(creatinine) as creat_count,
		count(chloride) as cl_count,
		count(glucose) as gluco_count,
		count(hematocrit) as hemato_count,
		count(hemoglobin) as hem_count,
		count(lactate) as lactate_count,
		count(platelet) as plat_count,
		count(potassium) as k_count,
		count(ptt) as ptt_count,
		count(inr) as inr_count,
		count(pt) as pt_count,
		count(sodium) as na_count,
		count(bun) as bun_count,
		count(wbc) as wbc_count
		FROM pivoted_lab
		GROUP BY hadm_id)



