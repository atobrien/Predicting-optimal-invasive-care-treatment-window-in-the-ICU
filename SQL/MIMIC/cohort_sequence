-- This cohort is derived from multiple other materialized views and tables from the MIMIC-III 
-- git hub repository  (https://github.com/MIT-LCP/mimic-code/tree/master/concepts),
-- which were either used directly or modified.

-- Reference for SOFA:
--    Jean-Louis Vincent, Rui Moreno, Jukka Takala, Sheila Willatts, Arnaldo De Mendon√ßa,
--    Hajo Bruining, C. K. Reinhart, Peter M Suter, and L. G. Thijs.
--    "The SOFA (Sepsis-related Organ Failure Assessment) score to describe organ dysfunction/failure."
--    Intensive care medicine 22, no. 7 (1996): 707-710.

-- Variables used in SOFA:
--  GCS, MAP, FiO2, Ventilation status (sourced from CHARTEVENTS)
--  Creatinine, Bilirubin, FiO2, PaO2, Platelets (sourced from LABEVENTS)
--  Dopamine, Dobutamine, Epinephrine, Norepinephrine (sourced from INPUTEVENTS_MV and INPUTEVENTS_CV)
--  Urine output (sourced from OUTPUTEVENTS)

-- The following views required to run the SOFA query:
--  1) pivoted_bg_art - generated by pivoted-bg.sql
--  2) pivoted_uo - generated by pivoted-uo.sql
--  3) pivoted_lab - generated by pivoted-lab.sql
--  4) pivoted_gcs - generated by pivoted-gcs.sql
--  5) ventdurations - generated by ../durations/ventilation-durations.sql
--  6) norepinephrine_dose - generated by ../durations/norepinephrine-dose.sql
--  7) epinephrine_dose - generated by ../durations/epinephrine-dose.sql
--  8) dopamine_dose - generated by ../durations/dopamine-dose.sql
--  9) dobutamine_dose - generated by ../durations/dobutamine-dose.sql

-- In addition to the tables used for SOFA, the modified tables used in this query are found at: 
-- https://github.com/atobrien/Predicting-optimal-invasive-care-treatment-window-in-the-ICU/tree/master/SQL/MIMIC
-- 1) CMO_sequence
-- 2) central_line_sequence
-- 3) crrt_sequence
-- 4) day_sequence
-- 5) mech_vent_seqeuence
-- 6) vasopressor_sequence


WITH v1 AS(
        SELECT
		*,
	    date_trunc('day', startday) AS day_start,
	    date_trunc('day', endday) AS day_end
	    FROM transition), 

     v2 AS(
	    SELECT
	    *,
	    cv_day AS day_start
	    FROM central), 

  	 v3 AS(
	    SELECT
	    *,
	    crrt_day AS day_start	
	    FROM crrt),
	 
	 v4 AS(
	    SELECT
	    *,
	    vasopres_day AS day_start
	    FROM vaso),

     m1 AS(
        SELECT
        *,
        date_trunc('day', charttime) AS day_start
        FROM mech_vent
        WHERE mechvent = 1 
        ORDER BY icustay_id, charttime),
 
     v5 AS(
 	    SELECT DISTINCT
        icustay_id,
        day_start,
		day_start AS mech_day,
        mechvent
        FROM m1),

      sofa AS(
	      SELECT 
          *,
          date_trunc('day', starttime) AS day_start
	      FROM pivoted_sofa
          ORDER BY icustay_id, starttime),

       v6 AS(
		  SELECT DISTINCT
          icustay_id,
          day_start,
          day_start AS sofa_day,
		  LAST_VALUE(sofa_24hours) OVER (PARTITION BY icustay_id, day_start ORDER BY day_start) AS sofa_last
		  FROM SOFA),

       v7 AS(
		  SELECT
          icustay_id,
          timecmo_chart,
          date_trunc('day', timecmo_chart) AS day_start,
          CASE WHEN timecmo_chart IS NOT NULL THEN 1 ELSE 0 END AS cmo_flag
          FROM status
          WHERE timecmo_chart IS NOT NULL
          ORDER BY icustay_id, day_start),

       v8 AS(
		  SELECT
		  *
		  FROM v1 --this is the day sequence table for patients in the icu
		  LEFT JOIN v2 --this is the central venous line table flag table
          USING (icustay_id,day_start)
          LEFT JOIN v3 --this is the continuous renal replacement therapy flag table
          USING (icustay_id,day_start)
          LEFT JOIN v4 --this is the vasopressor flag table
          USING (icustay_id,day_start)
          LEFT JOIN v5 --this is the mechanical ventilation flag table
          USING (icustay_id,day_start)
          LEFT JOIN v6 --this is the sofa 24 hour flag table
          USING (icustay_id,day_start)
          LEFT JOIN v7 --this is the cmo flag table
          USING (icustay_id,day_start)		   
		   ),
	
	 v9 AS(
        SELECT
        icustay_id,
        intime,
        outtime,
        startday,
        endday,
        icudayseq_asc,
        cv_flag,
        crrt_flag,
        vasopres_flag,
        mechvent AS mechvent_flag,
        cmo_flag,
        sofa_last,
        CASE WHEN (cv_flag = 1 OR crrt_flag = 1 OR vasopres_flag = 1 OR mechvent = 1) THEN 1 ELSE 0 END AS status_flag
        FROM v8)

SELECT
icustay_id,
intime,
outtime,
startday,
endday,
icudayseq_asc,
sofa_last,
CASE WHEN cmo_flag = 1 THEN 2 ELSE status_flag END AS state_transition
FROM v9
